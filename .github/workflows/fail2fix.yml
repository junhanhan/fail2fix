name: CI + Fail2Fix Bot (API logs)

on:
  pull_request:
  push:

permissions:
  contents: read
  actions: read
  pull-requests: write

jobs:
  test-and-autopsy:
    runs-on: ubuntu-latest

    steps:
            - name: Comment on PR
        if: ${{ github.event_name == 'pull_request' && steps.run_tests.outcome == 'failure' }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const report = JSON.parse(fs.readFileSync('report.json', 'utf8'));
            const snippet = (report.fatal_snippet || []).join('\n');
            const sig = report.error_signature || 'unknown';
            const conf = report.confidence || 'low';
            const meta = report.metadata || {};
            const reproCmd = meta.test_id ? `pytest -q ${meta.test_id}` : 'pytest -q';

            // simple suspects (rule-based)
            let suspects = [];
            if ((sig || '').includes('ModuleNotFoundError')) suspects.push('ä¾èµ–/requirements ç¼ºå¤±æˆ–åŒ…åå†™é”™');
            if ((sig || '').startsWith('assert:')) suspects.push('æ–­è¨€æœŸæœ›ç±»å‹/å€¼ä¸ä¸€è‡´ï¼Œæ£€æŸ¥è¢«æµ‹å‡½æ•°è¾“å‡ºç±»å‹');
            if ((sig || '').includes('timeout') || (sig || '').includes('OOM')) suspects.push('è¶…æ—¶/OOMï¼šæ£€æŸ¥æ•°æ®è§„æ¨¡ã€å¹¶å‘ã€å¤–éƒ¨æœåŠ¡');

            let suspectsText = '';
            if (suspects.length > 0) {
              suspectsText = `\n\n#### ğŸ” æ€€ç–‘ç‚¹ Top3\n` + suspects.map(s => `- ${s}`).join('\n');
            }

            const body =
`### ğŸ§ª Fail2Fix Bot æŠ¥å‘Š

**Error Signature:** \`${sig}\`  
**Confidence:** \`${conf}\`  
**Metadata:** \`${JSON.stringify(meta)}\`  
**å¤ç°å‘½ä»¤:** \`${reproCmd}\`${suspectsText}

<details><summary>Fatal Snippet</summary>

\`\`\`
${snippet}
\`\`\`

</details>
`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body
            });


**Error Signature:** \`${sig}\`  
**Confidence:** \`${conf}\`  
**å¤ç°å‘½ä»¤:** \`${reproCmd}\`
${suspectsText}

<details><summary>ğŸ“‹ Fatal Snippet</summary>

\`\`\`
${snippet}
\`\`\`

</details>

<details><summary>ğŸ“Š Metadata</summary>

\`\`\`json
${JSON.stringify(meta, null, 2)}
\`\`\`

</details>
`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body
            });
      
      - name: Fail job if tests failed
        if: ${{ steps.run_tests.outcome == 'failure' }}
        run: exit 1
